<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TANK CLASH ONLINE</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Black+Ops+One&family=VT323&display=swap');
:root{--gold:#ffd700;--red:#ff4040;--blue:#40c8ff;--green:#40ff80;--bg:#07070f;--border:rgba(255,255,255,0.09);}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);font-family:'VT323',monospace;color:#fff;min-height:100vh;display:flex;align-items:center;justify-content:center;overflow:hidden;}
body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(255,255,255,0.018) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,0.018) 1px,transparent 1px);background-size:36px 36px;animation:gm 22s linear infinite;pointer-events:none;z-index:0;}
@keyframes gm{from{background-position:0 0}to{background-position:0 36px}}
#app{position:relative;z-index:1;width:100%;max-width:980px;display:flex;flex-direction:column;align-items:center;}
.screen{display:none;flex-direction:column;align-items:center;width:100%;}.screen.active{display:flex;}
.game-title{font-family:'Black Ops One',cursive;font-size:54px;letter-spacing:6px;background:linear-gradient(135deg,var(--red),var(--gold),var(--blue));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;filter:drop-shadow(0 0 24px rgba(255,215,0,0.5));animation:pulse 3s ease-in-out infinite;margin-bottom:4px;}
.tagline{font-size:13px;letter-spacing:8px;color:#444;margin-bottom:30px;}
@keyframes pulse{0%,100%{filter:drop-shadow(0 0 14px rgba(255,215,0,0.3))}50%{filter:drop-shadow(0 0 40px rgba(255,215,0,0.8))}}
.lobby-card{width:500px;display:flex;flex-direction:column;align-items:center;gap:16px;}
.row2{display:flex;gap:16px;width:100%;}
.field{flex:1;display:flex;flex-direction:column;gap:6px;}
.field label{font-size:10px;letter-spacing:4px;color:#444;}
.field input{background:rgba(255,255,255,0.04);border:1px solid var(--border);color:#fff;font-family:'VT323',monospace;font-size:20px;letter-spacing:2px;padding:10px 14px;outline:none;width:100%;transition:border-color .2s;}
.field input:focus{border-color:var(--gold);}
.colors{display:flex;gap:10px;flex-wrap:wrap;padding-top:4px;}
.cdot{width:30px;height:30px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:all .18s;}
.cdot.on{border-color:#fff;transform:scale(1.25);}
.sv-row{display:flex;gap:12px;width:100%;}
.sv{flex:1;padding:18px 10px;background:rgba(255,255,255,0.03);border:1px solid var(--border);cursor:pointer;text-align:center;transition:all .2s;position:relative;}
.sv:hover,.sv.on{border-color:var(--gold);box-shadow:0 0 20px rgba(255,215,0,0.18);transform:translateY(-2px);background:rgba(255,215,0,0.04);}
.sv-flag{font-size:26px;margin-bottom:6px;}
.sv-name{font-family:'Black Ops One',cursive;font-size:12px;letter-spacing:2px;color:var(--gold);margin-bottom:8px;}
.sv-cnt{font-size:22px;}
.sv-bar{height:4px;background:rgba(255,255,255,0.06);margin-top:8px;border-radius:2px;overflow:hidden;}
.sv-fill{height:100%;border-radius:2px;}
.sv-tick{position:absolute;top:6px;right:8px;font-size:10px;color:var(--gold);display:none;}
.sv.on .sv-tick{display:block;}
.btn{background:transparent;cursor:pointer;font-family:'Black Ops One',cursive;font-size:15px;letter-spacing:4px;padding:14px 48px;border:2px solid var(--gold);color:var(--gold);text-shadow:0 0 10px var(--gold);box-shadow:0 0 20px rgba(255,215,0,0.1);transition:all .2s;}
.btn:hover:not(:disabled){background:rgba(255,215,0,0.08);box-shadow:0 0 40px rgba(255,215,0,0.4);transform:scale(1.04);}
.btn:disabled{opacity:.28;cursor:not-allowed;}
#lstat{min-height:20px;font-size:14px;letter-spacing:2px;text-align:center;color:#555;}
#lstat.ok{color:var(--green);text-shadow:0 0 8px var(--green);}
#lstat.err{color:var(--red);text-shadow:0 0 8px var(--red);}
#lstat.wait{color:var(--gold);text-shadow:0 0 8px var(--gold);}
#game-wrap{position:relative;display:flex;flex-direction:column;align-items:center;}
#hud{width:820px;height:56px;display:flex;align-items:center;background:rgba(0,0,0,0.88);border:1px solid var(--border);border-bottom:none;padding:0 8px;gap:6px;}
.phud{width:165px;flex-shrink:0;padding:3px 6px;}
.phud .pname{font-family:'Black Ops One',cursive;font-size:10px;letter-spacing:2px;margin-bottom:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.hp-wrap{height:7px;background:rgba(255,255,255,0.07);border-radius:3px;overflow:hidden;}
.hp-fill{height:100%;border-radius:3px;transition:width .12s;}
#hud-mid{flex:1;text-align:center;}
#hud-score{font-family:'Black Ops One',cursive;font-size:18px;letter-spacing:4px;color:var(--gold);text-shadow:0 0 12px var(--gold);}
#hud-room{font-size:9px;letter-spacing:2px;color:#222;margin-top:1px;}
#hud-lead{width:215px;flex-shrink:0;display:flex;flex-direction:column;justify-content:center;gap:2px;padding:3px 8px;border-left:1px solid rgba(255,255,255,0.06);}
.lead-row{display:flex;align-items:center;gap:5px;font-size:11px;line-height:1.4;}
.lead-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
.lead-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:11px;}
.lead-wins{color:var(--gold);font-family:'Black Ops One',cursive;font-size:10px;flex-shrink:0;}
canvas#c{display:block;border:1px solid var(--border);box-shadow:0 0 60px rgba(0,0,0,0.9);}
#go{position:absolute;top:56px;left:50%;transform:translateX(-50%);width:820px;bottom:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,0.92);z-index:10;backdrop-filter:blur(4px);}
#go.hide{display:none;}
.spinner{width:40px;height:40px;border:3px solid rgba(255,215,0,0.15);border-top-color:var(--gold);border-radius:50%;animation:spin .8s linear infinite;margin-bottom:14px;}
@keyframes spin{to{transform:rotate(360deg)}}
.dot-anim::after{content:'';animation:dots 1.4s steps(4,end) infinite;}
@keyframes dots{0%{content:''}25%{content:'.'}50%{content:'..'}75%{content:'...'}100%{content:''}}
#plist{width:380px;display:flex;flex-direction:column;gap:5px;max-height:200px;overflow-y:auto;margin-bottom:16px;}
.pr{display:flex;align-items:center;gap:10px;padding:7px 11px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.05);}
.pr-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
.pr-nick{font-size:17px;letter-spacing:2px;flex:1;}
.pr-you{font-size:10px;letter-spacing:2px;color:#333;}
.pr-sc{font-size:15px;color:#555;}
#chat{position:absolute;bottom:8px;left:8px;width:210px;z-index:5;}
#chat-log{display:flex;flex-direction:column;gap:2px;max-height:100px;overflow-y:auto;margin-bottom:4px;}
.cm{font-size:13px;padding:2px 6px;background:rgba(0,0,0,0.7);border-left:2px solid #222;letter-spacing:1px;}
#chat-row{display:flex;gap:4px;}
#ci{flex:1;background:rgba(0,0,0,0.7);border:1px solid #1a1a1a;color:#fff;font-family:'VT323',monospace;font-size:13px;padding:3px 6px;outline:none;}
#ci:focus{border-color:#333;}
#cs{background:transparent;border:1px solid #1a1a1a;color:#444;font-family:'VT323',monospace;font-size:13px;padding:3px 8px;cursor:pointer;}
#cs:hover{color:#888;border-color:#444;}
#kf{position:absolute;top:8px;right:8px;display:flex;flex-direction:column;gap:3px;z-index:5;pointer-events:none;}
.kfe{font-size:13px;padding:3px 10px;background:rgba(0,0,0,0.8);border-right:2px solid #f44;letter-spacing:1px;text-align:right;animation:kfi .3s ease;}
@keyframes kfi{from{opacity:0;transform:translateX(8px)}to{opacity:1;transform:none}}
#minimap-canvas{position:absolute;bottom:8px;right:8px;border:1px solid rgba(255,255,255,0.08);z-index:5;}
#ctrl-tip{position:absolute;bottom:96px;right:8px;font-size:10px;color:#1a1a28;letter-spacing:1px;text-align:right;line-height:2;z-index:5;}
</style>
</head>
<body>
<div id="app">
  <div id="lobby-screen" class="screen active">
    <div class="game-title">TANK CLASH</div>
    <div class="tagline">ONLINE PvP ‚Äî UP TO 8 PLAYERS</div>
    <div class="lobby-card">
      <div class="row2">
        <div class="field" style="flex:1.4"><label>YOUR NICKNAME</label><input id="nick" maxlength="12" placeholder="ACE" value="Player"/></div>
        <div class="field"><label>TANK COLOR</label><div class="colors" id="colors"></div></div>
      </div>
      <div style="font-size:10px;letter-spacing:4px;color:#2a2a38;width:100%;text-align:left;">PICK A SERVER</div>
      <div class="sv-row" id="svgrid"></div>
      <div id="lstat" class="wait">Connecting<span class="dot-anim"></span></div>
      <button class="btn" id="join-btn" disabled onclick="doJoin()">‚öî JOIN BATTLE</button>
      <div style="font-size:11px;color:#1a1a28;letter-spacing:2px;">ARROWS ‚Äî MOVE &nbsp;|&nbsp; SPACE ‚Äî FIRE &nbsp;|&nbsp; ENTER ‚Äî CHAT</div>
    </div>
  </div>
  <div id="game-screen" class="screen">
    <div id="game-wrap">
      <div id="hud">
        <div class="phud"><div class="pname" id="h-left">YOU</div><div class="hp-wrap"><div class="hp-fill" id="hp-left" style="width:100%"></div></div></div>
        <div id="hud-mid"><div id="hud-score">‚Äî</div><div id="hud-room">SERVER 1</div></div>
        <div class="phud" style="text-align:right"><div class="pname" id="h-right">OPPONENT</div><div class="hp-wrap"><div class="hp-fill" id="hp-right" style="width:100%;float:right"></div></div></div>
        <div id="hud-lead"></div>
      </div>
      <canvas id="c" width="820" height="560"></canvas>
      <div id="go">
        <div id="ph-conn" style="display:flex;flex-direction:column;align-items:center;gap:12px;">
          <div class="spinner"></div>
          <div style="font-family:'Black Ops One',cursive;font-size:18px;letter-spacing:4px;color:var(--gold);">CONNECTING<span class="dot-anim"></span></div>
        </div>
        <div id="ph-wait" style="display:none;flex-direction:column;align-items:center;">
          <div style="font-family:'Black Ops One',cursive;font-size:24px;letter-spacing:4px;margin-bottom:6px;">WAITING FOR PLAYERS</div>
          <div id="wait-sub" style="font-size:15px;letter-spacing:3px;color:#555;margin-bottom:20px;"></div>
          <div id="plist"></div>
          <button class="btn" id="start-btn" style="display:none" onclick="reqStart()">‚ñ∂ START GAME</button>
        </div>
        <div id="ph-end" style="display:none;flex-direction:column;align-items:center;gap:12px;">
          <div id="end-h" style="font-family:'Black Ops One',cursive;font-size:30px;letter-spacing:4px;"></div>
          <div id="end-s" style="font-size:16px;letter-spacing:3px;color:#555;margin-top:4px;"></div>
          <button class="btn" style="margin-top:10px;" onclick="reqStart()">‚ñ∂ NEXT ROUND</button>
        </div>
      </div>
      <div id="chat"><div id="chat-log"></div><div id="chat-row"><input id="ci" placeholder="chat..." maxlength="60" onkeydown="if(event.key==='Enter')sendChat()"/><button id="cs" onclick="sendChat()">‚ñ∂</button></div></div>
      <div id="kf"></div>
      <canvas id="minimap-canvas" width="120" height="90"></canvas>
      <div id="ctrl-tip">ARROWS ‚Äî MOVE<br>‚Üê ‚Üí ‚Äî ROTATE<br>SPACE ‚Äî FIRE</div>
    </div>
  </div>
</div>
<script src="https://cdn.ably.com/lib/ably.min-2.js"></script>
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TANK CLASH ‚Äî All bugs fixed
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ABLY_KEY = 'Xzs3kg.94NIEw:6DtlFTphDJ7SPj-HQKQfI-oVMLXHw5H1vU0JVu8VhlY';
const ROOMS = [{id:'tc-r1',name:'Server 1',flag:'üî¥'},{id:'tc-r2',name:'Server 2',flag:'üîµ'},{id:'tc-r3',name:'Server 3',flag:'üü¢'}];
const MAX_P = 8;
const COLORS = ['#ff4040','#40c8ff','#ffd700','#40ff80','#ff40ff','#ff9900','#00ffee','#a0ff40'];

// Big map: 2000x1500, viewport 820x560
const MAP_W=2000, MAP_H=1500, VP_W=820, VP_H=560;

const SPAWNS = [
  {x:130,y:750,a:0}, {x:1870,y:750,a:Math.PI},
  {x:1000,y:130,a:Math.PI/2}, {x:1000,y:1370,a:-Math.PI/2},
  {x:220,y:220,a:Math.PI/4}, {x:1780,y:220,a:Math.PI*3/4},
  {x:220,y:1280,a:-Math.PI/4}, {x:1780,y:1280,a:-Math.PI*3/4}
];

const T_SPD=3.2, T_TRN=0.046, B_SPD=8, F_CD=28;

let myId = 'p'+Math.random().toString(36).slice(2,9);
let myNick='Player', myColor=COLORS[0], myRoom=null;
let ably=null, channel=null, connected=false;
let players={}, myTank=null, gameActive=false;
let svCounts={};
let camX=MAP_W/2-VP_W/2, camY=MAP_H/2-VP_H/2;
let bullets=[], particles=[], shockwaves=[], walls=[];
let roundTimer=0, shakeFrames=0, shootTimer=0, bulletSeq=0;
const keys={};

// FIX blink: invulnTimer counts DOWN every frame in update() regardless of gameActive
// It is just a number: >0 = flashing, 0 = solid. update() always runs via loop().

// ‚îÄ‚îÄ color picker ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('colors').innerHTML='';
COLORS.forEach((c,i)=>{
  const d=document.createElement('div');
  d.className='cdot'+(i===0?' on':'');
  d.style.cssText='background:'+c+';box-shadow:0 0 8px '+c+'55';
  d.onclick=()=>{document.querySelectorAll('.cdot').forEach(x=>x.classList.remove('on'));d.classList.add('on');myColor=c;};
  document.getElementById('colors').appendChild(d);
});

// ‚îÄ‚îÄ server cards ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderServers(){
  const grid=document.getElementById('svgrid'); grid.innerHTML='';
  ROOMS.forEach(r=>{
    const cnt=svCounts[r.id]||0, full=cnt>=MAX_P, pct=(cnt/MAX_P)*100;
    const bc=pct<50?'#40ff80':pct<80?'#ffd700':'#ff4040';
    const d=document.createElement('div');
    d.className='sv'+(full?' full':'')+(myRoom===r.id?' on':'');
    d.innerHTML='<div class="sv-flag">'+r.flag+'</div>'
      +'<div class="sv-name">'+r.name+'</div>'
      +'<div class="sv-cnt" style="color:'+bc+'">'+cnt+'<span style="color:#333;font-size:13px"> / '+MAX_P+'</span></div>'
      +'<div class="sv-bar"><div class="sv-fill" style="width:'+pct+'%;background:'+bc+'"></div></div>'
      +'<div class="sv-tick">‚úì SELECTED</div>';
    if(!full) d.onclick=()=>{myRoom=r.id;renderServers();refreshBtn();};
    grid.appendChild(d);
  });
}
renderServers();

function refreshBtn(){
  const ok=connected&&!!myRoom;
  const btn=document.getElementById('join-btn');
  btn.disabled=!ok;
  btn.textContent=!connected?'‚öî JOIN BATTLE':(!myRoom?'SELECT A SERVER':'‚öî JOIN BATTLE');
}
function stat(m,c){const e=document.getElementById('lstat');e.textContent=m;e.className=c||'';}

// ‚îÄ‚îÄ auto-connect ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener('load',()=>{
  stat('Connecting...','wait');
  ably=new Ably.Realtime({key:ABLY_KEY,clientId:myId});

  ably.connection.on('connected',()=>{
    connected=true;
    stat('Connected! Pick a server and join.','ok');
    refreshBtn();
    // FIX 0/8: subscribe to presence on each room channel THEN get count
    // Must attach to channel first so presence.get() works
    ROOMS.forEach(r=>{
      const ch=ably.channels.get(r.id);
      ch.attach(()=>{
        const refresh=()=>{
          ch.presence.get((err,members)=>{
            if(!err){ svCounts[r.id]=members.length; renderServers(); }
          });
        };
        ch.presence.subscribe(refresh);
        refresh();
      });
    });
  });
  ably.connection.on('failed',()=>{connected=false;stat('Connection failed','err');refreshBtn();});
  ably.connection.on('disconnected',()=>{connected=false;stat('Disconnected‚Äîreconnecting...','err');refreshBtn();});
  ably.connection.on('suspended',()=>{connected=false;stat('Suspended‚Äîrefresh page','err');refreshBtn();});
});

document.getElementById('nick').oninput=()=>{myNick=document.getElementById('nick').value.trim()||'Player';};

// ‚îÄ‚îÄ join ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function doJoin(){
  myNick=document.getElementById('nick').value.trim()||'Player';
  document.getElementById('join-btn').disabled=true;

  channel=ably.channels.get(myRoom);
  channel.subscribe('mv',onMove);
  channel.subscribe('evt',onEvt);
  channel.subscribe('chat',onChatMsg);

  // FIX reset-on-join: only refresh overlay, never call doStart from presence
  channel.presence.subscribe(msg=>{
    if(msg.clientId===myId) return;
    if(msg.action==='enter'||msg.action==='present') regPlayer(msg.clientId,msg.data.nick,msg.data.color);
    if(msg.action==='leave') delete players[msg.clientId];
    if(!gameActive) refreshLobbyOverlay();
  });

  channel.presence.enter({nick:myNick,color:myColor})
    .then(()=>{
      showScreen('game-screen');
      document.getElementById('hud-room').textContent='SERVER '+(ROOMS.findIndex(r=>r.id===myRoom)+1);
      buildWalls(); showPhase('conn');
      return channel.presence.get();
    })
    .then(members=>{
      members.forEach(m=>{if(m.clientId!==myId) regPlayer(m.clientId,m.data.nick,m.data.color);});
      showPhase('wait'); refreshLobbyOverlay();
    })
    .catch(err=>{stat('Join failed: '+(err.message||err),'err');document.getElementById('join-btn').disabled=false;});
}

function regPlayer(id,nick,color){
  if(players[id]){players[id].nick=nick;players[id].color=color;return;}
  players[id]={id,nick,color,hp:100,alive:true,kills:0,wins:0,
               x:1000,y:750,angle:0,vx:0,vy:0,trail:[],
               invulnTimer:0}; // invulnTimer: frames remaining of blink
}

// ‚îÄ‚îÄ overlay ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showPhase(p){
  document.getElementById('ph-conn').style.display=p==='conn'?'flex':'none';
  document.getElementById('ph-wait').style.display=p==='wait'?'flex':'none';
  document.getElementById('ph-end').style.display=p==='end'?'flex':'none';
  document.getElementById('go').classList.remove('hide');
}
function hideOverlay(){document.getElementById('go').classList.add('hide');}

function refreshLobbyOverlay(){
  const all=allPlayers(), cnt=all.length;
  document.getElementById('wait-sub').textContent=cnt+' player'+(cnt!==1?'s':'')+' in room'+(cnt<2?' ‚Äî need 2 to start':'');
  document.getElementById('start-btn').style.display=cnt>=2?'block':'none';
  const list=document.getElementById('plist'); list.innerHTML='';
  all.forEach(p=>{
    const d=document.createElement('div'); d.className='pr';
    d.innerHTML='<div class="pr-dot" style="background:'+p.color+';box-shadow:0 0 6px '+p.color+'44"></div>'
      +'<div class="pr-nick" style="color:'+p.color+'">'+p.nick+'</div>'
      +'<div class="pr-you">'+(p.id===myId?'(YOU)':'')+'</div>'
      +'<div class="pr-sc">'+(p.kills||0)+'K &nbsp;'+(p.wins||0)+'W</div>';
    list.appendChild(d);
  });
}

function allPlayers(){
  const me={id:myId,nick:myNick,color:myColor,kills:players[myId]?.kills||0,wins:players[myId]?.wins||0};
  return [me,...Object.values(players).filter(p=>p.id!==myId)];
}

// ‚îÄ‚îÄ start round ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// FIX reset-on-join: each client generates and uses a unique nonce per start call
// so duplicate deliveries of the same message are ignored
let lastStartNonce='';

function reqStart(){
  const ids=[myId,...Object.keys(players)];
  const spawnMap={};
  ids.forEach((id,i)=>{ spawnMap[id]=SPAWNS[i%SPAWNS.length]; });
  const nonce=Math.random().toString(36).slice(2); // unique per button press
  channel.publish('evt',{e:'start',spawnMap,nonce});
}

function doStart(spawnMap, nonce){
  // FIX: ignore duplicate start messages (Ably echoes to sender AND network retries)
  if(nonce && nonce===lastStartNonce) return;
  if(nonce) lastStartNonce=nonce;

  bullets=[];particles=[];shockwaves=[];
  roundTimer=0;shootTimer=0;gameActive=true;

  const sp=spawnMap[myId]||SPAWNS[0];
  myTank={id:myId,nick:myNick,color:myColor,
          x:sp.x,y:sp.y,angle:sp.a,hp:100,alive:true,
          kills:players[myId]?.kills||0, wins:players[myId]?.wins||0,
          vx:0,vy:0,trail:[],invulnTimer:0};
  players[myId]=myTank;

  Object.keys(spawnMap).forEach(id=>{
    if(id===myId) return;
    const s=spawnMap[id];
    if(players[id]) Object.assign(players[id],{x:s.x,y:s.y,angle:s.a,hp:100,alive:true,vx:0,vy:0,trail:[],invulnTimer:0});
  });

  // snap camera
  camX=sp.x-VP_W/2; camY=sp.y-VP_H/2; clampCam();
  hideOverlay(); updateHUD();
}

// ‚îÄ‚îÄ remote messages ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function onMove(msg){
  const d=msg.data; if(d.id===myId) return;
  const p=players[d.id]; if(!p) return;
  p.x=lerp(p.x,d.x,0.35); p.y=lerp(p.y,d.y,0.35);
  p.angle=lerpAngle(p.angle,d.angle,0.35);
}

function onEvt(msg){
  const d=msg.data;

  if(d.e==='start'){
    doStart(d.spawnMap, d.nonce);
  }

  if(d.e==='shoot' && d.from!==myId){
    const p=players[d.from]; if(!p) return;
    bullets.push({id:d.bid,x:d.bx,y:d.by,
      vx:Math.cos(d.angle)*B_SPD,vy:Math.sin(d.angle)*B_SPD,
      owner:d.from,color:p.color,bounces:0});
  }

  if(d.e==='hit'){
    const v=players[d.victim]; if(!v) return;
    v.hp=d.hp;
    // FIX blink: set invulnTimer to countdown. It ALWAYS decrements in the game loop.
    v.invulnTimer=80;
    spawnPart(d.bx,d.by,v.color,14,4);
    spawnWave(d.bx,d.by,v.color);
    shakeFrames=6;
    bullets=bullets.filter(b=>b.id!==d.bid);
    if(d.hp<=0){
      v.alive=false;
      v.invulnTimer=0; // dead = no blink
      spawnPart(v.x,v.y,v.color,35,7);
      spawnWave(v.x,v.y,v.color);
      shakeFrames=10;
      addKF(d.knick,d.vnick);
      if(players[d.killer]) players[d.killer].kills=(players[d.killer].kills||0)+1;
    }
    updateHUD();
  }

  if(d.e==='over'){
    gameActive=false;
    if(d.winner&&players[d.winner]) players[d.winner].wins=(players[d.winner].wins||0)+1;
    updateHUD();
    const wColor=d.winner&&players[d.winner]?players[d.winner].color:'#fff';
    document.getElementById('end-h').textContent=d.wnick?'üèÜ '+d.wnick+' WINS!':'DRAW!';
    document.getElementById('end-h').style.color=wColor;
    document.getElementById('end-s').textContent=buildScoreBoard();
    showPhase('end'); refreshLobbyOverlay();
  }
}

function onChatMsg(msg){addChatLine(msg.data.nick,msg.data.msg,msg.data.color);}

// ‚îÄ‚îÄ physics helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('keydown',e=>{keys[e.code]=true;if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight','Space'].includes(e.code))e.preventDefault();});
document.addEventListener('keyup',e=>keys[e.code]=false);
function lerp(a,b,t){return a+(b-a)*t;}
function lerpAngle(a,b,t){let d=b-a;while(d>Math.PI)d-=Math.PI*2;while(d<-Math.PI)d+=Math.PI*2;return a+d*t;}
function rectsOverlap(ax,ay,aw,ah,bx,by,bw,bh){return ax<bx+bw&&ax+aw>bx&&ay<by+bh&&ay+ah>by;}
function tankInWall(t){for(const w of walls)if(rectsOverlap(t.x-14,t.y-12,28,24,w.x,w.y,w.w,w.h))return w;return null;}
function bulletHitsWall(b){for(const w of walls)if(b.x>w.x&&b.x<w.x+w.w&&b.y>w.y&&b.y<w.y+w.h)return w;return null;}
function clampCam(){camX=Math.max(0,Math.min(MAP_W-VP_W,camX));camY=Math.max(0,Math.min(MAP_H-VP_H,camY));}

function buildWalls(){
  const T=16;
  walls=[
    // borders
    {x:0,y:0,w:MAP_W,h:T},{x:0,y:MAP_H-T,w:MAP_W,h:T},
    {x:0,y:0,w:T,h:MAP_H},{x:MAP_W-T,y:0,w:T,h:MAP_H},
    // left zone
    {x:300,y:280,w:220,h:32},{x:300,y:1188,w:220,h:32},
    {x:180,y:500,w:32,h:220},{x:180,y:780,w:32,h:220},
    {x:440,y:620,w:180,h:32},
    // right zone (mirrored)
    {x:1480,y:280,w:220,h:32},{x:1480,y:1188,w:220,h:32},
    {x:1788,y:500,w:32,h:220},{x:1788,y:780,w:32,h:220},
    {x:1380,y:620,w:180,h:32},
    // top-center
    {x:860,y:200,w:32,h:220},{x:1108,y:200,w:32,h:220},
    {x:700,y:380,w:220,h:32},{x:1080,y:380,w:220,h:32},
    // bottom-center
    {x:860,y:1080,w:32,h:220},{x:1108,y:1080,w:32,h:220},
    {x:700,y:1088,w:220,h:32},{x:1080,y:1088,w:220,h:32},
    // center cluster
    {x:700,y:580,w:260,h:32},{x:1040,y:580,w:260,h:32},
    {x:700,y:888,w:260,h:32},{x:1040,y:888,w:260,h:32},
    {x:920,y:500,w:160,h:32},{x:920,y:968,w:160,h:32},
    {x:960,y:620,w:32,h:260},
    // mid-left/right
    {x:580,y:700,w:32,h:200},{x:1388,y:700,w:32,h:200},
  ];
}

function spawnPart(x,y,color,n,sp){
  for(let i=0;i<n;i++){const a=Math.random()*Math.PI*2,s=Math.random()*sp+1;particles.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,life:1,decay:Math.random()*.03+.015,r:Math.random()*3+1,color});}
}
function spawnWave(x,y,color){shockwaves.push({x,y,r:4,maxR:70,life:1,color});}

let lastSend=0;
function trySendMove(){
  if(!channel||!myTank) return;
  const now=Date.now(); if(now-lastSend<50) return; lastSend=now;
  channel.publish('mv',{id:myId,x:Math.round(myTank.x*10)/10,y:Math.round(myTank.y*10)/10,angle:Math.round(myTank.angle*100)/100});
}
function tryShoot(){
  if(!myTank||!myTank.alive||shootTimer>0) return;
  shootTimer=F_CD;
  const bid=myId+'_'+(bulletSeq++);
  const bx=myTank.x+Math.cos(myTank.angle)*22, by=myTank.y+Math.sin(myTank.angle)*22;
  bullets.push({id:bid,x:bx,y:by,vx:Math.cos(myTank.angle)*B_SPD,vy:Math.sin(myTank.angle)*B_SPD,owner:myId,color:myTank.color,bounces:0});
  myTank.vx-=Math.cos(myTank.angle)*1.5; myTank.vy-=Math.sin(myTank.angle)*1.5;
  channel.publish('evt',{e:'shoot',from:myId,bid,bx,by,angle:myTank.angle});
}

// ‚îÄ‚îÄ update (runs every frame regardless of gameActive) ‚îÄ
function update(){
  // FIX blink: ALWAYS decrement all invulnTimers ‚Äî even between rounds
  Object.values(players).forEach(p=>{ if(p.invulnTimer>0) p.invulnTimer--; });

  if(!gameActive) return;

  roundTimer++; if(shootTimer>0) shootTimer--;

  if(myTank&&myTank.alive){
    if(keys['ArrowLeft'])  myTank.angle-=T_TRN;
    if(keys['ArrowRight']) myTank.angle+=T_TRN;
    if(keys['ArrowUp'])    {myTank.vx+=Math.cos(myTank.angle)*.55;myTank.vy+=Math.sin(myTank.angle)*.55;}
    if(keys['ArrowDown'])  {myTank.vx-=Math.cos(myTank.angle)*.3;myTank.vy-=Math.sin(myTank.angle)*.3;}
    if(keys['Space']||keys['KeyL']) tryShoot();
    myTank.vx*=.83; myTank.vy*=.83;
    const spd=Math.hypot(myTank.vx,myTank.vy);
    if(spd>T_SPD){myTank.vx=myTank.vx/spd*T_SPD;myTank.vy=myTank.vy/spd*T_SPD;}
    const px=myTank.x,py=myTank.y;
    myTank.x+=myTank.vx; if(tankInWall(myTank)){myTank.x=px;myTank.vx*=-.3;}
    myTank.y+=myTank.vy; if(tankInWall(myTank)){myTank.y=py;myTank.vy*=-.3;}
    myTank.trail=myTank.trail||[];
    myTank.trail.unshift({x:myTank.x,y:myTank.y});
    if(myTank.trail.length>16) myTank.trail.pop();
    trySendMove();
    // smooth camera follows player
    camX=lerp(camX,myTank.x-VP_W/2,0.1);
    camY=lerp(camY,myTank.y-VP_H/2,0.1);
    clampCam();
  }

  // bullets
  for(let i=bullets.length-1;i>=0;i--){
    const b=bullets[i]; b.x+=b.vx; b.y+=b.vy;
    const hw=bulletHitsWall(b);
    if(hw){
      if(b.bounces>=2){spawnPart(b.x,b.y,b.color,5,2);bullets.splice(i,1);continue;}
      b.bounces++;
      const dx=(b.x-(hw.x+hw.w/2))/hw.w, dy=(b.y-(hw.y+hw.h/2))/hw.h;
      if(Math.abs(dx)>Math.abs(dy)) b.vx*=-1; else b.vy*=-1;
      spawnPart(b.x,b.y,b.color,4,2); continue;
    }
    if(b.owner===myId){
      let hit=false;
      for(const pid in players){
        if(pid===myId) continue;
        const t=players[pid];
        if(!t.alive||t.invulnTimer>0) continue;
        if(Math.hypot(b.x-t.x,b.y-t.y)<18){
          const newHp=Math.max(0,(t.hp||100)-20);
          t.hp=newHp; t.invulnTimer=80;
          channel.publish('evt',{e:'hit',from:myId,victim:pid,killer:myId,bid:b.id,bx:b.x,by:b.y,hp:newHp,knick:myNick,vnick:t.nick});
          spawnPart(b.x,b.y,t.color,14,4); spawnWave(b.x,b.y,t.color); shakeFrames=6;
          if(newHp<=0){
            t.alive=false; t.invulnTimer=0;
            spawnPart(t.x,t.y,t.color,35,7); spawnWave(t.x,t.y,t.color); shakeFrames=10;
            addKF(myNick,t.nick); myTank.kills=(myTank.kills||0)+1;
            updateHUD(); setTimeout(checkOver,300);
          }
          bullets.splice(i,1); hit=true; break;
        }
      }
      if(hit) continue;
    }
    if(b.x<-50||b.x>MAP_W+50||b.y<-50||b.y>MAP_H+50) bullets.splice(i,1);
  }

  for(let i=particles.length-1;i>=0;i--){const p=particles[i];p.x+=p.vx;p.y+=p.vy;p.vx*=.91;p.vy*=.91;p.life-=p.decay;if(p.life<=0)particles.splice(i,1);}
  for(let i=shockwaves.length-1;i>=0;i--){const s=shockwaves[i];s.r+=(s.maxR-s.r)*.18;s.life-=.055;if(s.life<=0)shockwaves.splice(i,1);}
}

function checkOver(){
  if(!gameActive) return;
  const alive=Object.values(players).filter(p=>p.alive);
  if(alive.length<=1){
    gameActive=false;
    const w=alive[0]||null;
    if(w) w.wins=(w.wins||0)+1;
    channel.publish('evt',{e:'over',winner:w?.id||null,wnick:w?.nick||null});
    updateHUD();
    document.getElementById('end-h').textContent=w?'üèÜ '+w.nick+' WINS!':'DRAW!';
    document.getElementById('end-h').style.color=w?w.color:'#fff';
    document.getElementById('end-s').textContent=buildScoreBoard();
    showPhase('end'); refreshLobbyOverlay();
  }
}

// ‚îÄ‚îÄ HUD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildScoreBoard(){
  const all=Object.values(players);
  if(!all.length) return '';
  return all.sort((a,b)=>(b.wins||0)-(a.wins||0)).map(p=>p.nick+' '+( p.wins||0)+'W').join('  ¬∑  ');
}

function updateHUD(){
  const me=players[myId]||myTank;
  const opp=Object.values(players).find(p=>p.id!==myId);
  if(me){
    document.getElementById('h-left').textContent='‚ñ∂ '+me.nick;
    document.getElementById('h-left').style.color=me.color;
    document.getElementById('hp-left').style.cssText='width:'+Math.max(0,me.hp||0)+'%;background:'+me.color+';box-shadow:0 0 6px '+me.color;
  }
  if(opp){
    document.getElementById('h-right').textContent=opp.nick+' ‚óÄ';
    document.getElementById('h-right').style.color=opp.color;
    document.getElementById('hp-right').style.cssText='width:'+Math.max(0,opp.hp||0)+'%;background:'+opp.color+';box-shadow:0 0 6px '+opp.color+';float:right';
  }
  // FIX leaderboard: show all players sorted by wins with crown on leader
  const sorted=Object.values(players).sort((a,b)=>(b.wins||0)-(a.wins||0));
  const lead=document.getElementById('hud-lead'); lead.innerHTML='';
  sorted.slice(0,4).forEach((p,i)=>{
    const r=document.createElement('div'); r.className='lead-row';
    const crown=i===0&&(p.wins||0)>0?'üëë ':'';
    r.innerHTML=crown
      +'<div class="lead-dot" style="background:'+p.color+';box-shadow:0 0 4px '+p.color+'"></div>'
      +'<span class="lead-name" style="color:'+p.color+'">'+p.nick+'</span>'
      +'<span class="lead-wins">'+(p.wins||0)+'W</span>';
    lead.appendChild(r);
  });
  // score = top 2 by wins
  const top2=sorted.slice(0,2);
  document.getElementById('hud-score').textContent=top2.length>=2?top2[0].wins+'‚Äî'+top2[1].wins:top2.length===1?top2[0].wins+'W':'‚Äî';
}

// ‚îÄ‚îÄ chat/kf ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function addChatLine(nick,msg,color){
  const log=document.getElementById('chat-log');
  const d=document.createElement('div'); d.className='cm';
  d.innerHTML='<span style="color:'+(color||'#888')+'">'+nick+':</span> '+msg;
  log.appendChild(d); log.scrollTop=log.scrollHeight;
  while(log.children.length>16) log.removeChild(log.firstChild);
}
function sendChat(){
  const ci=document.getElementById('ci'), msg=ci.value.trim();
  if(!msg||!channel) return;
  channel.publish('chat',{nick:myNick,msg,color:myColor});
  addChatLine('YOU',msg,myColor); ci.value='';
}
function addKF(k,v){
  const kf=document.getElementById('kf');
  const d=document.createElement('div'); d.className='kfe';
  d.textContent=k+' ‚ö° '+v; kf.appendChild(d); setTimeout(()=>d.remove(),4000);
}
function showScreen(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');}

// ‚îÄ‚îÄ draw ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const canvas=document.getElementById('c');
const ctx=canvas.getContext('2d');
const mm=document.getElementById('minimap-canvas');
const mctx=mm.getContext('2d');

function draw(){
  ctx.save();
  if(shakeFrames>0){ctx.translate((Math.random()-.5)*shakeFrames*.8,(Math.random()-.5)*shakeFrames*.8);shakeFrames--;}
  // camera transform
  ctx.translate(-Math.round(camX),-Math.round(camY));
  // background
  ctx.fillStyle='#0c0c18'; ctx.fillRect(camX,camY,VP_W,VP_H);
  // hex grid (visible tiles only)
  ctx.save(); ctx.globalAlpha=.02; ctx.strokeStyle='#fff'; ctx.lineWidth=.5;
  const hs=40;
  const r0=Math.floor(camY/(hs*1.5))-1, r1=r0+Math.ceil(VP_H/(hs*1.5))+3;
  const c0=Math.floor(camX/(hs*1.73))-1, c1=c0+Math.ceil(VP_W/(hs*1.73))+3;
  for(let row=r0;row<r1;row++) for(let col=c0;col<c1;col++){
    const cx=col*hs*1.73+(row%2)*hs*.865, cy=row*hs*1.5;
    ctx.beginPath();
    for(let k=0;k<6;k++){const a=(Math.PI/3)*k-Math.PI/6; k===0?ctx.moveTo(cx+hs*Math.cos(a),cy+hs*Math.sin(a)):ctx.lineTo(cx+hs*Math.cos(a),cy+hs*Math.sin(a));}
    ctx.closePath(); ctx.stroke();
  }
  ctx.restore();
  // walls
  for(const w of walls){
    if(w.x+w.w<camX||w.x>camX+VP_W||w.y+w.h<camY||w.y>camY+VP_H) continue;
    const g=ctx.createLinearGradient(w.x,w.y,w.x,w.y+w.h);
    g.addColorStop(0,'#252538'); g.addColorStop(1,'#111120');
    ctx.fillStyle=g; ctx.fillRect(w.x,w.y,w.w,w.h);
    ctx.strokeStyle='rgba(255,255,255,0.07)'; ctx.lineWidth=1;
    ctx.strokeRect(w.x+.5,w.y+.5,w.w-1,w.h-1);
  }
  // shockwaves
  for(const s of shockwaves){
    ctx.save(); ctx.globalAlpha=s.life*.65;
    ctx.strokeStyle=s.color; ctx.shadowColor=s.color; ctx.shadowBlur=14; ctx.lineWidth=2.5;
    ctx.beginPath(); ctx.arc(s.x,s.y,s.r,0,Math.PI*2); ctx.stroke();
    ctx.globalAlpha=s.life*.1; ctx.fillStyle=s.color; ctx.fill(); ctx.restore();
  }
  // particles
  for(const p of particles){
    ctx.save(); ctx.globalAlpha=p.life; ctx.shadowColor=p.color; ctx.shadowBlur=9;
    ctx.fillStyle=p.color; ctx.beginPath(); ctx.arc(p.x,p.y,p.r*p.life,0,Math.PI*2); ctx.fill(); ctx.restore();
  }
  // bullets
  for(const b of bullets){
    ctx.save();
    const g=ctx.createLinearGradient(b.x-b.vx*6,b.y-b.vy*6,b.x,b.y);
    g.addColorStop(0,'transparent'); g.addColorStop(1,b.color+'bb');
    ctx.strokeStyle=g; ctx.lineWidth=2.5;
    ctx.beginPath(); ctx.moveTo(b.x-b.vx*6,b.y-b.vy*6); ctx.lineTo(b.x,b.y); ctx.stroke();
    ctx.shadowColor=b.color; ctx.shadowBlur=14;
    ctx.fillStyle='#fff'; ctx.beginPath(); ctx.arc(b.x,b.y,4.5,0,Math.PI*2); ctx.fill();
    ctx.fillStyle=b.color; ctx.beginPath(); ctx.arc(b.x,b.y,3,0,Math.PI*2); ctx.fill();
    ctx.restore();
  }
  // tanks
  for(const id in players){ const t=players[id]; if(t.alive) drawTank(t,id===myId); }
  ctx.restore(); // remove cam transform
  drawMinimap();
}

function drawTank(t,isMe){
  const trail=t.trail||[];
  ctx.save();
  for(let i=trail.length-1;i>=0;i--){
    const a=(1-i/trail.length)*.12;
    ctx.beginPath(); ctx.arc(trail[i].x,trail[i].y,10*(1-i/trail.length),0,Math.PI*2);
    ctx.fillStyle=t.color+Math.floor(a*255).toString(16).padStart(2,'0'); ctx.fill();
  }
  // FIX blink: invulnTimer counts down from 80‚Üí0. Blink every 6 frames. At 0: solid, no more flicker.
  const blink=t.invulnTimer>0 && Math.floor(t.invulnTimer/6)%2===1;
  if(blink){ctx.restore();return;}

  ctx.translate(t.x,t.y); ctx.rotate(t.angle);
  ctx.shadowColor=t.color; ctx.shadowBlur=20;
  ctx.fillStyle=t.color; ctx.beginPath(); ctx.roundRect(-15,-12,30,24,4); ctx.fill();
  ctx.shadowBlur=0;
  ctx.fillStyle='rgba(0,0,0,0.35)'; ctx.beginPath(); ctx.roundRect(-15,-12,30,24,4); ctx.fill();
  ctx.fillStyle='rgba(255,255,255,0.2)'; ctx.beginPath(); ctx.roundRect(-13,-10,26,10,3); ctx.fill();
  ctx.strokeStyle='rgba(0,0,0,0.4)'; ctx.lineWidth=1.5;
  ctx.beginPath(); ctx.moveTo(-5,-12); ctx.lineTo(-5,12); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(5,-12);  ctx.lineTo(5,12);  ctx.stroke();
  ctx.shadowColor=t.color; ctx.shadowBlur=12;
  ctx.fillStyle=t.color; ctx.beginPath(); ctx.arc(0,0,9,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='rgba(255,255,255,0.22)'; ctx.beginPath(); ctx.arc(-2,-2,5,0,Math.PI*2); ctx.fill();
  ctx.fillStyle=t.color; ctx.shadowBlur=10; ctx.fillRect(7,-3.5,20,7);
  ctx.fillStyle='#fff'; ctx.shadowBlur=18; ctx.fillRect(25,-2.5,4,5);
  ctx.shadowBlur=0; ctx.fillStyle='rgba(0,0,0,0.65)';
  [-8,0,8].forEach(x=>{ctx.fillRect(x-3.5,-16,7,5);ctx.fillRect(x-3.5,11,7,5);});
  ctx.restore();

  // name + hp bar in world space
  ctx.save();
  ctx.textAlign='center'; ctx.font='bold 13px VT323,monospace';
  ctx.fillStyle=isMe?'#fff':t.color; ctx.shadowColor=t.color; ctx.shadowBlur=8;
  ctx.fillText((isMe?'‚ñ∂ ':'')+t.nick, t.x, t.y-30);
  const bw=44,bh=5,bx=t.x-bw/2,by=t.y-38;
  ctx.shadowBlur=0;
  ctx.fillStyle='rgba(0,0,0,0.5)'; ctx.fillRect(bx-1,by-1,bw+2,bh+2);
  ctx.fillStyle='rgba(255,255,255,0.05)'; ctx.fillRect(bx,by,bw,bh);
  const pct=(t.hp||0)/100;
  const bc=pct>.5?t.color:pct>.25?'#ffaa00':'#ff2020';
  ctx.fillStyle=bc; ctx.shadowColor=bc; ctx.shadowBlur=6;
  ctx.fillRect(bx,by,bw*pct,bh);
  ctx.restore();
}

function drawMinimap(){
  const mw=mm.width, mh=mm.height;
  mctx.fillStyle='rgba(0,0,0,0.88)'; mctx.fillRect(0,0,mw,mh);
  // walls
  mctx.fillStyle='#1e1e30';
  walls.forEach(w=>{mctx.fillRect(w.x/MAP_W*mw,w.y/MAP_H*mh,Math.max(1,w.w/MAP_W*mw),Math.max(1,w.h/MAP_H*mh));});
  // viewport box
  mctx.strokeStyle='rgba(255,255,255,0.14)'; mctx.lineWidth=1;
  mctx.strokeRect(camX/MAP_W*mw, camY/MAP_H*mh, VP_W/MAP_W*mw, VP_H/MAP_H*mh);
  // player dots
  Object.values(players).forEach(p=>{
    if(!p.alive) return;
    mctx.fillStyle=p.color; mctx.shadowColor=p.color; mctx.shadowBlur=4;
    mctx.beginPath();
    mctx.arc(p.x/MAP_W*mw, p.y/MAP_H*mh, p.id===myId?4:3, 0, Math.PI*2);
    mctx.fill();
  });
  mctx.shadowBlur=0;
}

buildWalls();
function loop(){ update(); draw(); requestAnimationFrame(loop); }
loop();
</script>
</body>
</html>
